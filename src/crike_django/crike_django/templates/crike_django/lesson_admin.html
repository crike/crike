{% extends 'base.html' %}

{% block content %}
{% load crispy_forms_tags %}
<link href="/static/index.css" rel="stylesheet" type="text/css"/>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script language="javascript" type="text/javascript">
  $(document).ready ( function(){
    $('#UpdWordForm').find('input[id="id_name"]').prop('readonly', true);
  });
  var timer = null;
  function playSound(mp3) {
     //$('#dummy').html("<audio preload='auto' autoplay src='"+mp3+"' type='audio/mpeg'></audio>");
     $('#dummy').html("<embed autostart='true' height=0 width=0 src='"+mp3+"'></embed>");
  };
  function callback(mp3) {
      playSound(mp3);
  };
  function delayPlay(mp3) {
      clearTimeout(timer);
      var cb = "callback('"+mp3+"')";
      timer = setTimeout(cb, 500);
  };
  function showForm(form) {
    if (document.getElementById(form).style.display == 'none') {
      //$('form:not(#'+form.id+')').hide();
      $('form').hide();
      $('#'+form).show();
    } else {
      $('#'+form).hide();
    }
  };
  function checkall(t) {
    if (t.checked) {
      $('#DelWordForm').find('input[name="delwords"]').prop('checked', true);
    } else {
      $('#DelWordForm').find('input[name="delwords"]').prop('checked', false);
    }
  };
  function radioOn(name) {
    phonetics = $('#'+name+'div').find('li[id="id_phonetics"]').text().replace('[','').replace(']','');
    var means = [];
    $('#'+name+'div').find('li[id="id_mean"]').each(function() { means.push($(this).text()) });
    mean = means.join("\n");
    $('#UpdWordForm').find('input[id="id_name"]').prop('value', name);
    $('#UpdWordForm').find('input[id="id_phonetics"]').prop('value', phonetics);
    //waste a lot of time on .text(), that will not change the textarea once modified the content, use .val() !!!!
    $('#UpdWordForm').find('textarea[id="id_mean"]').val(mean);
  };
</script>
<div class='jumbotron'>
  <label>{{book}}</label>
  <h1>{{lesson}}</h1>
  <button class="btn btn-primary btn-lg" onclick="showForm('RenameForm' )">修改名称</button>
  <button class="btn btn-success btn-lg" onclick="showForm('AddWordForm')">添加单词</button>
  <button class="btn btn-danger btn-lg"  onclick="showForm('DelWordForm')">删除单词</button>
  <button class="btn btn-info btn-lg"    onclick="showForm('UpdWordForm')">修改单词</button>
  {% if showform == "RenameForm" %}
  <form id="RenameForm" method="post" action="/admin/book/{{book}}/lesson/{{lesson}}/" style="display:block">
  {% else %}
  <form id="RenameForm" method="post" action="/admin/book/{{book}}/lesson/{{lesson}}/" style="display:none">
  {% endif %}
    {% csrf_token %}
    <input type="text" name="newname">
    <input type="hidden" name="extra" value="rename">
    <input type="submit" value="提交">
    <strong>{{warning}}</strong>
  </form>
  {% if showform == "AddWordForm" %}
  <form id="AddWordForm" enctype="multipart/form-data" method="post" action="/admin/book/{{book}}/lesson/{{lesson}}/" style="display:block">
  {% else %}
  <form id="AddWordForm" enctype="multipart/form-data" method="post" action="/admin/book/{{book}}/lesson/{{lesson}}/" style="display:none">
  {% endif %}
    {% csrf_token %}
    {{AddWordForm|crispy}}
    <input type="hidden" name="extra" value="addword">
    <input type='submit' value='提交'>
    <strong>{{ warning }}</strong>
  </form>
  {% if Showform == "DelWordForm" %}
  <form id="DelWordForm" style="display:block" method="post" action="/admin/book/{{book}}/lesson/{{lesson}}/">
  {% else %}
  <form id="DelWordForm" style="display:none" method="post" action="/admin/book/{{book}}/lesson/{{lesson}}/">
  {% endif %}
    {% csrf_token %}
    <label>请选择要删除的单词</label>
    <input type='checkbox' name='delinfos'>从词库中删除
    <input type='checkbox' name='delaudio'>删除音频文件<br>
    <input type='checkbox' onclick="checkall(this);">全选<br>
    {% for word in words %}
    <input type='checkbox' name='delwords' value='{{word.name}}'>{{word.name}}
    {% endfor %}
    <input type='hidden' name='extra' value='delword'>
    <input id="deletesubmit" type="submit" value="delete">
    <strong>{{ warning }}</strong>
  </form>
  {% if showform == "UpdWordForm" %}
  <form id="UpdWordForm" enctype="multipart/form-data" method="post" action="/admin/book/{{book}}/lesson/{{lesson}}/" style="display:block">
  {% else %}
  <form id="UpdWordForm" enctype="multipart/form-data" method="post" action="/admin/book/{{book}}/lesson/{{lesson}}/" style="display:none">
  {% endif %}
    {% for word in words %}
    <input type='radio' name="updword" onclick='radioOn("{{word.name}}")'>{{word.name}}
    {% endfor %}
    {% csrf_token %}
    {{AddWordForm|crispy}}
    <input type="hidden" name="extra" value="updword">
    <input type='submit' value='提交'>
    <strong>{{ warning }}</strong>
  </form>
</div>
<!-- Cycle through entries -->
<div class='row'>
{% for word in words %}
  <div id='{{word.name}}div'class="col-6 col-sm-6 col-lg-3">  
    <h2> {{ word.name }}</h2>
    <p>
      <li style='display:inline' id='id_phonetics'><strong>[{{ word.phonetics }}]</strong></li>
      <li style='display:inline'>
      <a onmouseover="delayPlay('/media/audios/{{ word.name }}.mp3');"
          onmouseout ="clearTimeout(timer);" 
          onclick="playSound('/media/audios/{{ word.name }}.mp3');" 
          title="发音" href="javascript:;"><i class="fa fa-volume-up"></i></a>
      </li>
    </p>
    {% for mean in word.mean %}
    <p>
      <li id='id_mean'>{{mean}}</li>
    </p>
    {% endfor %}
  </div>
{% endfor %}
</div>
<span id="dummy"></span>
{% endblock %}
