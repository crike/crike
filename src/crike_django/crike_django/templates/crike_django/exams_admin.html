{% extends 'base.html' %}

{% block content %}
{% load staticfiles %}
{% load crispy_forms_tags %}
<link href="/static/index.css" rel="stylesheet" type="text/css"/>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script language="javascript" type="text/javascript">
  var books = "{"+{% for book in books %}"'{{book}}':'{{book}}',"+{% endfor %}"}";
  var lessons = "";
  var lessonsOfbooks = {
    {% for book in books %}
    "{{book.name}}":"{"+
      {% for lesson in book.lessons %}
    "'{{lesson}}:{{lesson.words|length}}|{{lesson.id}}':'{{lesson}}:{{lesson.words|length}}',"+
      {% endfor %}"}",
    {% endfor %}
  };

$(function() {

  $(".editable_selectbook").editable(function(value, settings){
    $(this).html(value);
    lessons = lessonsOfbooks[value];
    $(this).parents('form').find('#select_2').parent('p').remove();
    $(this).parent('p').after('<p><script>$(".editable_selectlesson").editable(function(value, settings){'+
        '$(this).html(value);onSelectlesson(this,"'+value+'",value);}, {data:'+lessons+
        ',type:"select",submit:"OK",style:"inherit",tooltip:"点击修改",});'+
        '<\/script>课程:<b class="editable_selectlesson" id="select_2" style="display:inline;">点击选择</b></p>');
    }, {
    indicator : '<img src="img/indicator.gif">',
    data   : books,
    type   : "select",
    submit : 'OK',
    style  : "inherit",
    tooltip : "点击修改",
    submitdata : function() {
      return {id : 2};
    }
  });
  $(".editable_examname").editable(function(value, settings){
      var names = $('.editable_examname').not(this)
                                         .map(function() {
                                                return $(this).text();
                                              }).get();
      if ($.inArray(value, names) == -1){
        $(this).html(value);
        $(this).parent('h2').find('#modified').show();
        $(this).parent('h2').find('button').show();
      } else
        $(this).html("名称已存在，请重命名");
    }, { 
      type   : 'text',
      select : true,
      submit : "√",
      cancel : "×",
      tooltip : "点击修改",
  });
  $(".editable_readingname").editable(function(value, settings){
      var names = $(this).parents('form')
                         .find('.editable_readingname').not(this)
                                                    .map(function() {
                                                           return $(this).text();
                                                         }).get();
      if ($.inArray(value, names) == -1){
        $(this).html(value);
        $(this).parent('h2').find('#modified').show();
        $(this).parent('h2').find('button').show();
      } else
        $(this).html("名称已存在，请重命名");
    }, { 
      type   : 'text',
      select : true,
      submit : "√",
      cancel : "×",
      tooltip : "点击修改",
  });
  $(".autogrow_article").editable(function(value, settings) {
        //console.log(value.indexOf('\n'));
        //value.replaceAll('\n', '<br>new');
        $(this).html(value);
      }, { 
      indicator : "<img src='img/indicator.gif'>",
      type      : "autogrow",
      select    : true,
      submit    : 'OK',
      cancel    : 'cancel',
      tooltip   : "Click to edit...",
      onblur    : "ignore",
      autogrow : {
         lineHeight : 32,
         minHeight  : 32
      },
    submitdata : function() {
      return {id : 2};
    }
  });
  $(".autogrow_question").editable(function(value, settings) {
        $(this).html(value);
      }, { 
      indicator : "<img src='img/indicator.gif'>",
      type      : "autogrow",
      select    : true,
      submit    : 'OK',
      cancel    : 'cancel',
      tooltip   : "Click to edit...",
      onblur    : "ignore",
      autogrow : {
         lineHeight : 32,
         minHeight  : 32
      },
    submitdata : function() {
      return {id : 2};
    }
  });
  $(".autogrow_choice").editable(function(value, settings) {
        $(this).html(value);
      }, { 
      indicator : "<img src='img/indicator.gif'>",
      type      : "autogrow",
      select    : true,
      submit    : 'OK',
      cancel    : 'cancel',
      tooltip   : "Click to edit...",
      onblur    : "ignore",
      autogrow : {
         linewidth  : 64,
         lineHeight : 32,
         minHeight  : 32
      },
    submitdata : function() {
      return {id : 2};
    }
  });
  $(".editable_textarea").editable("#", { 
      indicator : "<img src='img/indicator.gif'>",
      type   : 'textarea',
      submitdata: { _method: "put" },
      select : true,
      submit : 'OK',
      cancel : 'cancel',
      cssclass : "editable"
  });
  $(".editable_textile").editable("#", { 
      indicator : "<img src='img/indicator.gif'>",
      loadurl   : "#",
      type      : "textarea",
      submit    : "OK",
      cancel    : "Cancel",
      tooltip   : "Click to edit..."
  });
  
  $(".click").editable("#", { 
      indicator : "<img src='img/indicator.gif'>",
      tooltip   : "Click to edit...",
      style  : "inherit"
  });
  $(".dblclick").editable("#", { 
      indicator : "<img src='img/indicator.gif'>",
      tooltip   : "Doubleclick to edit...",
      event     : "dblclick",
      style  : "inherit"
  });
  $(".mouseover").editable("#", { 
      indicator : "<img src='img/indicator.gif'>",
      tooltip   : "Move mouseover to edit...",
      event     : "mouseover",
      style  : "inherit"
  });
  
  /* Should not cause error. */
  $("#nosuch").editable("#", { 
      indicator : "<img src='img/indicator.gif'>",
      type   : 'textarea',
      submit : 'OK'
  });

});

function showExamform() {
  if (!$("#newexamform").is(":visible")) {
    $("#deleteform").hide();
    $(".checkexam").hide();
    $("#newexamform").show();
  } else {
    $("#newexamform").hide();
  }
};
function saveExam(me) {
  var form = $(me).parents('form');//or closest('form')
  var name = $(form).find('.editable_examname').html();
  var names = $('.editable_examname').not($(form).find('.editable_examname'))
              .map(function() {
                     return $(this).text();
                   }).get();
  if ($.inArray(name, names) == -1) {
    $('<input>').attr({name:'name', value:name, hidden:'true'}).appendTo(form);
    $(form).submit();
  }else
    $(form).find('.editable_examname').html("名称已存在，请重命名");
};
function onDoubleclickthumbnail(thumbnail) {
  var id = $(thumbnail).find('input').attr('value');
  var form = $(thumbnail).parents('form'); 
  $(form).find( "input:checkbox[id="+id+"]" ).prop('checked', false);
  $(thumbnail).parents('form').find('h2 button').show();
  $(thumbnail).remove();
};
function onSelectlesson(me, book, value) {
  var index1 = value.lastIndexOf(':');
  var index2 = value.lastIndexOf('|');
  var name = value.substring(0,index1);
  var length = value.substring(index1+1,index2);
  var id = value.substring(index2+1);
  $(me).parents('form').find('h2 button').show();
  $(me).parents('form').find('#addnew').before(
      '<div class="col-6 col-sm-6 col-lg-2" ondblclick="onDoubleclickthumbnail(this)">'+
      '<a class="thumbnail" style="width:100%;cursor:pointer;" title="双击删除">'+
      '<input name="addlessons" value='+id+' hidden="true"><p>'
      +book+'</p><p><b>'+name+'</b></p><p style="color:sienna;">sum:'+length+'</p></a></div>');
  $(me).parents('form').find('#select_1').text("点击选择");
  $(me).parents('form').find('#select_2').text("点击选择");
};
function expandExam(me) {
  var content = $(me).parents('form').find('.content');
  if (content.is(":visible")) {
    content.hide();
    $(me).prop('class','fa fa-caret-right');
  } else {
    content.show();
    $(me).prop('class','fa fa-caret-down');
  }
};
function deleteExam(me) {
  var form = $(me).parents('form');
  $('<input>').attr({name:'delexam', value:'true', hidden:'true'}).appendTo(form);
  $(form).submit();
};
</script>

<div class="jumbotron">
  <h1>Crike -- 试题管理</h1>
</div>
<button class="btn btn-success" onclick="showExamform();"><i class="fa fa-plus"></i></button>
<!-- add new item -->
<form id='newexamform' style="display: none" method="post" action="/admin/exams/">
  {% csrf_token %}
  <h2>新增：<b class="editable_examname" id="text_1">Click to input a name</b>&nbsp&nbsp*
    <button onclick="saveExam(this);" class="btn btn-success" style="float:right;display=none">
      <i class="fa fa-save"></i></button>
  </h2>
  <h4>词汇测验</h4>
  <div class='row'>
    <div id="addnew" class="col-6 col-sm-6 col-lg-2">
      <p>新增</p>
      <p>课本:<b class="editable_selectbook" id="select_1" style="display:inline">点击选择</b></p>
    </div>
  </div>
  <h4>阅读理解</h4>
  <a style="cursor:pointer;" onclick="event.preventDefault();return;"><i class="fa fa-plus"></i></a>
  <div class='row'>
    <p>Article: </p>
    <div class="col-12 col-sm-12 col-lg-12">
      <div class="thumbnail">
        <p><b class="editable_readingname" id="text_reading_name">Click to input title</b></p>
        <p class="autogrow_article">click to input article</p>
      </div>
    </div>
    <p>Questions: </p>
    <div class="col-12 col-sm-12 col-lg-12">
      <div class="thumbnail">
        <p class="autogrow_question">question</p>
      </div>
    </div>
    <div class="col-6 col-sm-6 col-lg-3">
      <input type="radio" name="answer">
      <div class="thumbnail">A<p id="choice_1" class="autogrow_choice"></p></div>
    </div>
    <div class="col-6 col-sm-6 col-lg-3">
      <input type="radio" name="answer">
      <div class="thumbnail">B<p id="choice_2" class="autogrow_choice"></p></div>
    </div>
    <div class="col-6 col-sm-6 col-lg-3">
      <input type="radio" name="answer">
      <div class="thumbnail">C<p id="choice_3" class="autogrow_choice"></p></div>
    </div>
    <div class="col-6 col-sm-6 col-lg-3">
      <input type="radio" name="answer">
      <div class="thumbnail">D<p id="choice_4" class="autogrow_choice"></p></div>
    </div>
  </div>
</form>

{% if Showform == "deleteform" %}
<form id="deleteform" style="display:block" enctype="multipart/form-data" method="post" action="/admin/exams/">
{% else %}
<form id="deleteform" style="display:none" enctype="multipart/form-data" method="post" action="/admin/exams/">
{% endif %}
  {% csrf_token %}
  <label>请选择要删除的试卷</label>
  <input hidden='true' name='extra' value='delete'>
  <input id="deletesubmit" type="submit" disabled="true" value="delete">
  <strong>{{ Deletewarning }}</strong>
</form>
<!-- Cycle through entries -->
{% for exam in exams %}
<form id='examform' method="post" action="/admin/exams/">
  {% csrf_token %}
  <input name='id' value="{{exam.id}}" hidden="true">
  <h2><a style="cursor:pointer;"><i class="fa fa-caret-right" style="font-size:80%" onclick="expandExam(this)"></i></a>
    <b class="editable_examname" id="text_1">{{exam.name}}</b>
    <b id="modified" style="display:none">&nbsp&nbsp*</b>
    <button onclick="saveExam(this);" class="btn btn-success" style="float:right;display:none">
      <i class="fa fa-save"></i></button>
    <button class="btn btn-danger" style="float:right;" onclick="deleteExam(this);">
      <i class="fa fa-minus"></i></button>
  </h2>
  <div class="content" style="display:none">
    <h4>词汇测验</h4>
  <!-- vocabularies -->
    <div class='row'>
      {% for lesson in exam.lessons|dictsort:"name" %}
      <div class="col-6 col-sm-6 col-lg-2" ondblclick="onDoubleclickthumbnail(this)">
        <a class="thumbnail" style="width:100%;cursor:pointer;" title="双击删除">
          <p><input name="addlessons" value='{{lesson.id}}' hidden="true">{{lesson.book.name}}</p>
          <p><b>{{lesson.name}}</b></p>
          <p style="color:sienna;">sum:{{lesson.words|length}}</p>
        </a>
      </div>
      {% endfor %}
      <div id="addnew" class="col-6 col-sm-6 col-lg-2">
        <p>新增</p>
        <p>课本:<b class="editable_selectbook" id="select_1" style="display:inline">点击选择</b></p>
      </div>
    </div>
  <!-- reading comprehensions -->
    <h4>阅读理解</h4>
      <button class="btn btn-success" onclick="showExamform();">添加</button>
      {% for reading in exam.readings %}
        {{reading.name}}<br><!--TODO editable reading areas-->
         <p class="autogrow" style="width: 300px">Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidun t ut laoreet dolore magna aliquam erat volutpat.</p>
         <p>Depends on by Chrys Bader.</p>
      {% endfor %}
  </div>
</form>
{% endfor %}

<span id="dummy"></span>
{% block body_footer %}
<script src="{% static 'jeditable/jquery.jeditable.js' %}" type="text/javascript" charset="utf-8"></script>
<script src="{% static 'jeditable/jquery.jeditable.autogrow.js' %}"></script>
<script src="{% static 'jeditable/jquery.autogrow.js' %}"></script>
{% endblock %}

{% endblock %}
